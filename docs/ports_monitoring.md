# Система портов и мониторинга устройств

## Автоматическое назначение портов

При обнаружении нового устройства через UDP Discovery, система автоматически назначает ему уникальный порт из диапазона **9005-9230**.

### Логика работы

1. **Новое устройство** - получает первый свободный порт (начиная с 9005)
2. **Существующее устройство** - сохраняет свой порт при переподключении
3. **Максимум устройств** - 226 (9230 - 9005 + 1)

### Пример

```
Устройство UID=12345 обнаружено → назначен порт 9005
Устройство UID=67890 обнаружено → назначен порт 9006
Устройство UID=12345 переподключилось → порт остался 9005
```

## Мониторинг устройств

Система автоматически проверяет доступность всех зарегистрированных устройств каждые **30 секунд**.

### Проверка доступности

- **Метод**: TCP ping на порт 50000
- **Timeout**: 2 секунды
- **Интервал**: 30 секунд

### Статусы устройств

- `Online: true` - устройство доступно
- `Online: false` - устройство недоступно (но остается в реестре)

### Важно

❗ При потере связи устройство **НЕ удаляется** из реестра, только помечается как `offline`.  
❗ Порт устройства **сохраняется** даже при offline статусе.

## Интеграция с ССТМК

Система ССТМК определяет устройства по назначенным портам:

```
http://localhost:9005/onvif/device_service  → Устройство 1
http://localhost:9006/onvif/device_service  → Устройство 2
http://localhost:9007/onvif/device_service  → Устройство 3
```

## Код

### Registry Store

```go
// Автоматическое назначение портов
store.Upsert(device) // Порт назначается автоматически

// Проверка статуса
store.SetOnline(deviceID, true/false)
```

### Мониторинг

```go
// Запуск в bootstrap
go registry.StartMonitoring(ctx, 30*time.Second)
```

## Конфигурация

Диапазон портов жестко задан в коде:
- Минимум: 9005
- Максимум: 9230

Для изменения диапазона отредактируйте `internal/registry/registry.go`:

```go
func (s *Store) allocatePort() int {
    for port := 9005; port <= 9230; port++ {
        // ...
    }
}
```
